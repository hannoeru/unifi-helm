suite: test networkpolicy
templates:
  - networkpolicy.yaml
tests:
  - it: should not render NetworkPolicy when disabled
    set:
      networkPolicy.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should render NetworkPolicy when enabled
    set:
      networkPolicy.enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: NetworkPolicy
      - equal:
          path: metadata.name
          value: RELEASE-NAME-unifi
      - contains:
          path: spec.policyTypes
          content: "Ingress"
      - contains:
          path: spec.policyTypes
          content: "Egress"

  - it: should render NetworkPolicy with custom ingress rules
    set:
      networkPolicy.enabled: true
      networkPolicy.ingress:
        - from:
            - ipBlock:
                cidr: "10.0.0.0/8"
          ports:
            - protocol: TCP
              port: 8443
    asserts:
      - equal:
          path: spec.ingress[0].from[0].ipBlock.cidr
          value: "10.0.0.0/8"
      - equal:
          path: spec.ingress[0].ports[0].protocol
          value: "TCP"
      - equal:
          path: spec.ingress[0].ports[0].port
          value: 8443

  - it: should render NetworkPolicy with custom egress rules
    set:
      networkPolicy.enabled: true
      networkPolicy.egress:
        - to:
            - ipBlock:
                cidr: "0.0.0.0/0"
          ports:
            - protocol: TCP
              port: 443
    asserts:
      - equal:
          path: spec.egress[0].to[0].ipBlock.cidr
          value: "0.0.0.0/0"
      - equal:
          path: spec.egress[0].ports[0].protocol
          value: "TCP"
      - equal:
          path: spec.egress[0].ports[0].port
          value: 443

  - it: should render NetworkPolicy with pod selector
    set:
      networkPolicy.enabled: true
    asserts:
      - equal:
          path: spec.podSelector.matchLabels["app.kubernetes.io/name"]
          value: unifi
      - equal:
          path: spec.podSelector.matchLabels["app.kubernetes.io/instance"]
          value: RELEASE-NAME